import{r as x,j as e}from"./app-G7oNGmaq.js";import{B as P}from"./button-Bx0bN2-W.js";import{U as L}from"./upload-DtqWPbO-.js";function M({data:g,columns:S,errors:y,onCellEdit:_,validationMetadata:N}){var C;const[l,k]=x.useState(null),[a,E]=x.useState(null),[m,i]=x.useState(""),b=x.useRef(null),v=x.useRef(null),j=[{key:"row_id",label:"#",width:60,readOnly:!0},{key:"name",label:"Name",width:200,required:!0},{key:"email",label:"Email",width:250,required:!0},{key:"phone",label:"Phone",width:150,required:!0},{key:"department",label:"Department",width:180,required:!0},{key:"session",label:"Session",width:120,required:!0},{key:"gender",label:"Gender",width:100,required:!0},{key:"class_roll",label:"Roll",width:100},{key:"blood_group",label:"Blood Group",width:120},{key:"member_id",label:"Member ID",width:150,readOnly:!0}];x.useEffect(()=>{a&&v.current&&(v.current.focus(),typeof v.current.select=="function"&&v.current.select())},[a]);const z=(s,r)=>{k({rowId:s,field:r})},D=(s,r,t)=>{const n=j.find(u=>u.key===r);n!=null&&n.readOnly||(E({rowId:s,field:r}),i(t||""))},F=(s,r,t)=>{if(a)s.key==="Enter"||s.key==="Tab"?(s.preventDefault(),O(),s.key==="Enter"?w(r+1,t):s.key==="Tab"&&(s.shiftKey?w(r,t-1):w(r,t+1))):s.key==="Escape"&&A();else if(s.key==="ArrowUp")s.preventDefault(),w(r-1,t);else if(s.key==="ArrowDown")s.preventDefault(),w(r+1,t);else if(s.key==="ArrowLeft")s.preventDefault(),w(r,t-1);else if(s.key==="ArrowRight")s.preventDefault(),w(r,t+1);else if(s.key==="Enter"||s.key==="F2"){s.preventDefault();const n=g[r],u=j[t];n&&u&&!u.readOnly&&D(n.row_id,u.key,n[u.key])}},w=(s,r)=>{if(s>=0&&s<g.length&&r>=0&&r<j.length){const t=g[s],n=j[r];k({rowId:t.row_id,field:n.key})}},O=()=>{a&&(_(a.rowId,a.field,m),E(null),i(""))},A=()=>{E(null),i("")},T=(s,r)=>s[r]||"",o=(s,r)=>{var t;return(t=y[s])==null?void 0:t[r]},f=s=>y[s]&&Object.keys(y[s]).length>0?"bg-red-50 border-l-4 border-red-500":"hover:bg-gray-50",c=(s,r,t)=>{const n=(l==null?void 0:l.rowId)===s&&(l==null?void 0:l.field)===r,u=(a==null?void 0:a.rowId)===s&&(a==null?void 0:a.field)===r,R=o(s,r),q=!T(g.find(B=>B.row_id===s),r),V=t.required;let d=["border border-gray-300 h-8 text-sm relative cursor-cell","hover:bg-blue-50 focus-within:bg-blue-50"];return n&&!u&&d.push("ring-2 ring-blue-500 bg-blue-50"),u&&d.push("ring-2 ring-blue-600 bg-white"),R?d.push("bg-red-100 border-red-400"):q?V&&q&&d.push("bg-yellow-50 border-yellow-300"):d.push("bg-green-50 border-green-300"),t.readOnly&&d.push("bg-gray-100 cursor-not-allowed"),d.join(" ")},p=s=>{if(!N)return null;switch(s){case"department":return N.departments;case"gender":return N.genders;case"blood_group":return N.blood_groups;default:return null}},h=(s,r,t,n)=>{const u=(a==null?void 0:a.rowId)===s.row_id&&(a==null?void 0:a.field)===r.key,R=T(s,r.key),q=o(s.row_id,r.key),V=p(r.key);return u?V?e.jsxs("select",{ref:v,value:m,onChange:d=>i(d.target.value),onBlur:O,onKeyDown:d=>F(d,t,n),className:"w-full h-full border-none bg-transparent focus:ring-0 text-sm px-1",children:[e.jsx("option",{value:"",children:"Select..."}),V.map(d=>e.jsx("option",{value:d,children:d},d))]}):e.jsx("input",{ref:v,type:r.key==="email"?"email":r.key==="phone"?"tel":"text",value:m,onChange:d=>i(d.target.value),onBlur:O,onKeyDown:d=>F(d,t,n),className:"w-full h-full border-none bg-transparent focus:ring-0 text-sm px-1",placeholder:r.required?"Required":"Optional"}):e.jsxs("div",{className:"flex items-center justify-between w-full h-full px-1",children:[e.jsx("span",{className:`truncate ${!R&&r.required?"text-gray-400 italic":"text-gray-900"}`,children:R||(r.required?"Required":"")}),q&&e.jsxs("div",{className:"ml-1 relative group",children:[e.jsx("svg",{className:"w-3 h-3 text-red-500 flex-shrink-0",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z",clipRule:"evenodd"})}),e.jsx("div",{className:"absolute bottom-full right-0 mb-1 hidden group-hover:block z-10",children:e.jsxs("div",{className:"bg-red-900 text-white text-xs rounded py-1 px-2 whitespace-nowrap max-w-48",children:[q.message,e.jsx("div",{className:"absolute top-full right-2 w-0 h-0 border-l-2 border-r-2 border-t-2 border-transparent border-t-red-900"})]})})]})]})};return e.jsxs("div",{className:"h-full flex flex-col bg-white",children:[e.jsxs("div",{className:"flex items-center justify-between p-2 bg-gray-100 border-b border-gray-300",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-700",children:"Excel Import Preview"}),l&&e.jsxs("div",{className:"text-xs text-gray-600 bg-white px-2 py-1 rounded border",children:["Cell: ",(C=j.find(s=>s.key===l.field))==null?void 0:C.label," - Row ",g.findIndex(s=>s.row_id===l.rowId)+1]})]}),e.jsxs("div",{className:"flex items-center space-x-2 text-xs text-gray-600",children:[e.jsx("span",{children:"F2 or Double-click to edit"}),e.jsx("span",{children:"•"}),e.jsx("span",{children:"Enter/Tab to navigate"})]})]}),e.jsx("div",{ref:b,className:"flex-1 overflow-auto bg-white",style:{height:"calc(100% - 48px)"},children:e.jsxs("table",{className:"w-full border-collapse",children:[e.jsx("thead",{className:"sticky top-0 bg-gray-200 z-10",children:e.jsx("tr",{children:j.map(s=>e.jsx("th",{className:"border border-gray-400 bg-gray-200 text-left text-xs font-semibold text-gray-700 p-1",style:{width:s.width,minWidth:s.width},children:e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("span",{children:s.label}),s.required&&e.jsx("span",{className:"text-red-500 text-xs",children:"*"})]})},s.key))})}),e.jsx("tbody",{children:g.map((s,r)=>e.jsx("tr",{className:`group ${f(s.row_id)}`,children:j.map((t,n)=>e.jsx("td",{className:c(s.row_id,t.key,t),style:{width:t.width,minWidth:t.width},onClick:()=>z(s.row_id,t.key),onDoubleClick:()=>D(s.row_id,t.key,T(s,t.key)),tabIndex:0,onKeyDown:u=>F(u,r,n),children:h(s,t,r,n)},`${s.row_id}-${t.key}`))},s.row_id))})]})})]})}function K({isOpen:g,onClose:S,file:y,validationMetadata:_,onImport:N}){var A,T;const[l,k]=x.useState(null),[a,E]=x.useState({}),[m,i]=x.useState(!1),[b,v]=x.useState(!1),j=x.useRef(null),z=x.useRef(null);x.useEffect(()=>{g&&y&&D()},[g,y]),x.useEffect(()=>{const o=Object.keys(a||{}).reduce((f,c)=>f+Object.keys(a[c]||{}).length,0);v(o>0)},[a]);const D=async()=>{i(!0);const o=new FormData;o.append("excel_file",y);try{const c=await(await fetch(route("admin.users.import.preview"),{method:"POST",body:o,headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),Accept:"application/json"}})).json();if(console.log("API Response:",c),c.success){console.log("Preview Data:",c.data),k(c.data);const p={};c.data.errors&&Array.isArray(c.data.errors)&&c.data.errors.forEach(h=>{h.severity==="error"&&(p[h.row]||(p[h.row]={}),p[h.row][h.column]=h)}),E(p)}else console.error("API Error:",c.message),alert(c.message||"Error loading file preview")}catch(f){console.error("Preview error:",f),alert("Error loading file preview. Please try again.")}finally{i(!1)}},F=async(o,f,c)=>{console.log("Cell edit:",{rowId:o,field:f,value:c});const p=l.rows.map(h=>h.row_id===o?{...h,[f]:c}:h);k({...l,rows:p}),z.current&&clearTimeout(z.current),z.current=setTimeout(async()=>{const h=p.find(C=>C.row_id===o);try{const s=await(await fetch(route("admin.users.import.validate-row"),{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),Accept:"application/json"},body:JSON.stringify({row_id:o,data:h})})).json();if(console.log("Validation result:",s),s.success){const r={...a};if(s.errors&&s.errors.length>0){const t={};s.errors.forEach(n=>{n.severity==="error"&&(t[n.column]=n)}),Object.keys(t).length>0?r[o]=t:delete r[o]}else delete r[o];E(r),k(t=>{const n=t.rows.map(u=>{if(u.row_id===o){const R={...u};return s.member_id&&s.member_id!==u.member_id&&(R.member_id=s.member_id),R}return u});return{...t,rows:n}})}}catch(C){console.error("Cell validation error:",C)}},500)},w=async()=>{if(b){alert("Please fix all validation errors before importing.");return}i(!0);try{const o=l.rows.map((p,h)=>{const{row_id:C,...s}=p;return{...s,row_number:h+1}}),f=await fetch(route("admin.users.import.batch"),{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),Accept:"application/json"},body:JSON.stringify({rows:o,chunk_size:50,session_id:l.session_id})});if(!f.ok){const p=await f.text();throw console.error("Import response error:",p),new Error(`HTTP ${f.status}: ${p}`)}const c=await f.json();c.success?(N(c),S()):(console.error("Import failed:",c),alert(c.message||"Import failed"))}catch(o){console.error("Import error:",o),alert("Import failed: "+o.message)}finally{i(!1)}},O=()=>{l!=null&&l.session_id&&fetch(route("admin.users.import.clear-session"),{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")}}),S()};return g?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{ref:j,className:"bg-white rounded-lg shadow-2xl w-full max-w-7xl h-full max-h-[90vh] flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200 bg-gray-50 rounded-t-lg",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("svg",{className:"w-6 h-6 text-green-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),e.jsxs("h2",{className:"text-xl font-semibold text-gray-900",children:["Excel Import - ",y==null?void 0:y.name]})]}),l&&l.rows&&e.jsxs("div",{className:"text-sm text-gray-600 bg-white px-3 py-1 rounded-full border",children:[((A=l.rows)==null?void 0:A.length)||0," rows • ",((T=l.columns)==null?void 0:T.length)||0," columns"]})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[l&&e.jsx("div",{className:`flex items-center space-x-2 px-3 py-1 rounded-full text-sm font-medium ${b?"bg-red-100 text-red-800 border border-red-200":"bg-green-100 text-green-800 border border-green-200"}`,children:b?e.jsxs(e.Fragment,{children:[e.jsx("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z",clipRule:"evenodd"})}),e.jsx("span",{children:"Has Errors"})]}):e.jsxs(e.Fragment,{children:[e.jsx("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z",clipRule:"evenodd"})}),e.jsx("span",{children:"Ready to Import"})]})}),e.jsx("button",{onClick:w,disabled:b||m||!l,className:`px-6 py-2 rounded-lg font-medium transition-all ${b||m||!l?"bg-gray-300 text-gray-500 cursor-not-allowed":"bg-green-600 text-white hover:bg-green-700 shadow-lg hover:shadow-xl"}`,children:m?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("svg",{className:"animate-spin w-4 h-4",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),e.jsx("span",{children:"Processing..."})]}):"Import to Database"}),e.jsx("button",{onClick:O,className:"p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100 transition-colors",children:e.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M6 18L18 6M6 6l12 12"})})})]})]}),e.jsx("div",{className:"flex-1 overflow-hidden",children:m&&!l?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("svg",{className:"animate-spin w-12 h-12 text-blue-600 mx-auto mb-4",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),e.jsx("p",{className:"text-lg font-medium text-gray-700",children:"Loading Excel file..."}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Parsing and validating data"})]})}):l?e.jsx(M,{data:l.rows,columns:l.columns||[],errors:a,onCellEdit:F,validationMetadata:_}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center text-gray-500",children:[e.jsx("svg",{className:"w-16 h-16 mx-auto mb-4 text-gray-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),e.jsx("p",{className:"text-lg",children:"No file loaded"})]})})}),l&&e.jsx("div",{className:"p-4 border-t border-gray-200 bg-gray-50 rounded-b-lg",children:e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center space-x-6",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-3 h-3 bg-red-100 border-2 border-red-500 rounded"}),e.jsx("span",{className:"text-gray-600",children:"Validation Error"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-3 h-3 bg-green-100 border-2 border-green-500 rounded"}),e.jsx("span",{className:"text-gray-600",children:"Valid Data"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:"text-red-500 font-bold",children:"*"}),e.jsx("span",{className:"text-gray-600",children:"Required Field"})]})]}),e.jsx("div",{className:"text-gray-600",children:"Double-click cells to edit • Tab/Enter to navigate"})]})})]})}):null}function U({validationMetadata:g,onImportComplete:S}){const[y,_]=x.useState(!1),[N,l]=x.useState(null),k=m=>{const i=m.target.files[0];if(i){const b=i.name.toLowerCase();if(![".xlsx",".xls"].some(D=>b.endsWith(D))&&!["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-excel","application/excel","application/x-excel","application/x-msexcel",""].includes(i.type)){alert(`Please select a valid Excel file (.xlsx or .xls). Selected file: ${b}`);return}if(i.size>10*1024*1024){alert("File size must be less than 10MB");return}console.log("File selected:",{name:i.name,type:i.type,size:i.size}),l(i),_(!0)}},a=()=>{_(!1),l(null);const m=document.getElementById("excel-upload");m&&(m.value="")},E=m=>{_(!1),l(null);const i=document.getElementById("excel-upload");i&&(i.value=""),S&&S(m)};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"file",accept:".xlsx,.xls",onChange:k,className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10",id:"excel-upload"}),e.jsx(P,{variant:"outline",asChild:!0,className:"cursor-pointer",children:e.jsxs("label",{htmlFor:"excel-upload",children:[e.jsx(L,{className:"h-4 w-4"}),"Import User Excel File"]})})]}),e.jsx(K,{isOpen:y,onClose:a,file:N,validationMetadata:g,onImport:E})]})}export{U as E};
