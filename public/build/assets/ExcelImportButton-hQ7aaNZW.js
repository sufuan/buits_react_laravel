import{r as x,j as e}from"./app-DKN0tjNm.js";import{B as M}from"./button-DYJaCCQJ.js";import{U as $}from"./upload-OIC9hBgX.js";function I({data:b,columns:D,errors:j,onCellEdit:R,validationMetadata:E}){var y;const[l,C]=x.useState(null),[a,_]=x.useState(null),[p,o]=x.useState(""),w=x.useRef(null),N=x.useRef(null),u=[{key:"row_id",label:"#",width:60,readOnly:!0},{key:"name",label:"Name",width:200,required:!0},{key:"email",label:"Email",width:250,required:!0},{key:"phone",label:"Phone",width:150,required:!0},{key:"department",label:"Department",width:180,required:!0},{key:"session",label:"Session",width:120,required:!0},{key:"gender",label:"Gender",width:100,required:!0},{key:"class_roll",label:"Roll",width:100},{key:"blood_group",label:"Blood Group",width:120},{key:"member_id",label:"Member ID",width:150,readOnly:!0}];x.useEffect(()=>{a&&N.current&&(N.current.focus(),typeof N.current.select=="function"&&N.current.select())},[a]);const S=(s,r)=>{C({rowId:s,field:r})},F=(s,r,t)=>{const i=u.find(c=>c.key===r);i!=null&&i.readOnly||(_({rowId:s,field:r}),o(t||""))},z=(s,r,t)=>{if(a)s.key==="Enter"||s.key==="Tab"?(s.preventDefault(),A(),s.key==="Enter"?k(r+1,t):s.key==="Tab"&&(s.shiftKey?k(r,t-1):k(r,t+1))):s.key==="Escape"&&q();else if(s.key==="ArrowUp")s.preventDefault(),k(r-1,t);else if(s.key==="ArrowDown")s.preventDefault(),k(r+1,t);else if(s.key==="ArrowLeft")s.preventDefault(),k(r,t-1);else if(s.key==="ArrowRight")s.preventDefault(),k(r,t+1);else if(s.key==="Enter"||s.key==="F2"){s.preventDefault();const i=b[r],c=u[t];i&&c&&!c.readOnly&&F(i.row_id,c.key,i[c.key])}},k=(s,r)=>{if(s>=0&&s<b.length&&r>=0&&r<u.length){const t=b[s],i=u[r];C({rowId:t.row_id,field:i.key})}},A=()=>{a&&(R(a.rowId,a.field,p),_(null),o(""))},q=()=>{_(null),o("")},O=(s,r)=>s[r]||"",P=(s,r)=>{var t;return(t=j[s])==null?void 0:t[r]},V=s=>j[s]&&Object.keys(j[s]).length>0?"bg-red-50 border-l-4 border-red-500":"hover:bg-gray-50",n=(s,r,t)=>{const i=(l==null?void 0:l.rowId)===s&&(l==null?void 0:l.field)===r,c=(a==null?void 0:a.rowId)===s&&(a==null?void 0:a.field)===r,g=P(s,r),h=!O(b.find(T=>T.row_id===s),r),v=t.required;let d=["border border-gray-300 h-8 text-sm relative cursor-cell","hover:bg-blue-50 focus-within:bg-blue-50"];return i&&!c&&d.push("ring-2 ring-blue-500 bg-blue-50"),c&&d.push("ring-2 ring-blue-600 bg-white"),g?d.push("bg-red-100 border-red-400"):h?v&&h&&d.push("bg-yellow-50 border-yellow-300"):d.push("bg-green-50 border-green-300"),t.readOnly&&d.push("bg-gray-100 cursor-not-allowed"),d.join(" ")},f=s=>{if(!E)return null;switch(s){case"department":return E.departments;case"gender":return E.genders;case"blood_group":return E.blood_groups;default:return null}},m=(s,r,t,i)=>{const c=(a==null?void 0:a.rowId)===s.row_id&&(a==null?void 0:a.field)===r.key,g=O(s,r.key),h=P(s.row_id,r.key),v=f(r.key);return c?v?e.jsxs("select",{ref:N,value:p,onChange:d=>o(d.target.value),onBlur:A,onKeyDown:d=>z(d,t,i),className:"w-full h-full border-none bg-transparent focus:ring-0 text-sm px-1",children:[e.jsx("option",{value:"",children:"Select..."}),v.map(d=>e.jsx("option",{value:d,children:d},d))]}):e.jsx("input",{ref:N,type:r.key==="email"?"email":r.key==="phone"?"tel":"text",value:p,onChange:d=>o(d.target.value),onBlur:A,onKeyDown:d=>z(d,t,i),className:"w-full h-full border-none bg-transparent focus:ring-0 text-sm px-1",placeholder:r.required?"Required":"Optional"}):e.jsxs("div",{className:"flex items-center justify-between w-full h-full px-1",children:[e.jsx("span",{className:`truncate ${!g&&r.required?"text-gray-400 italic":"text-gray-900"}`,children:g||(r.required?"Required":"")}),h&&e.jsxs("div",{className:"ml-1 relative group",children:[e.jsx("svg",{className:"w-3 h-3 text-red-500 flex-shrink-0",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z",clipRule:"evenodd"})}),e.jsx("div",{className:"absolute bottom-full right-0 mb-1 hidden group-hover:block z-10",children:e.jsxs("div",{className:"bg-red-900 text-white text-xs rounded py-1 px-2 whitespace-nowrap max-w-48",children:[h.message,e.jsx("div",{className:"absolute top-full right-2 w-0 h-0 border-l-2 border-r-2 border-t-2 border-transparent border-t-red-900"})]})})]})]})};return e.jsxs("div",{className:"h-full flex flex-col bg-white",children:[e.jsxs("div",{className:"flex items-center justify-between p-2 bg-gray-100 border-b border-gray-300",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-700",children:"Excel Import Preview"}),l&&e.jsxs("div",{className:"text-xs text-gray-600 bg-white px-2 py-1 rounded border",children:["Cell: ",(y=u.find(s=>s.key===l.field))==null?void 0:y.label," - Row ",b.findIndex(s=>s.row_id===l.rowId)+1]})]}),e.jsxs("div",{className:"flex items-center space-x-2 text-xs text-gray-600",children:[e.jsx("span",{children:"F2 or Double-click to edit"}),e.jsx("span",{children:"•"}),e.jsx("span",{children:"Enter/Tab to navigate"})]})]}),e.jsx("div",{ref:w,className:"flex-1 overflow-auto bg-white",style:{height:"calc(100% - 48px)"},children:e.jsxs("table",{className:"w-full border-collapse",children:[e.jsx("thead",{className:"sticky top-0 bg-gray-200 z-10",children:e.jsx("tr",{children:u.map(s=>e.jsx("th",{className:"border border-gray-400 bg-gray-200 text-left text-xs font-semibold text-gray-700 p-1",style:{width:s.width,minWidth:s.width},children:e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx("span",{children:s.label}),s.required&&e.jsx("span",{className:"text-red-500 text-xs",children:"*"})]})},s.key))})}),e.jsx("tbody",{children:b.map((s,r)=>e.jsx("tr",{className:`group ${V(s.row_id)}`,children:u.map((t,i)=>e.jsx("td",{className:n(s.row_id,t.key,t),style:{width:t.width,minWidth:t.width},onClick:()=>S(s.row_id,t.key),onDoubleClick:()=>F(s.row_id,t.key,O(s,t.key)),tabIndex:0,onKeyDown:c=>z(c,r,i),children:m(s,t,r,i)},`${s.row_id}-${t.key}`))},s.row_id))})]})})]})}function W({isOpen:b,onClose:D,file:j,validationMetadata:R,onImport:E}){var P,V;const[l,C]=x.useState(null),[a,_]=x.useState({}),[p,o]=x.useState(!1),[w,N]=x.useState(!1),[u,S]=x.useState({isImporting:!1,current:0,total:0,percentage:0}),F=x.useRef(null),z=x.useRef(null);x.useEffect(()=>{b&&j&&k()},[b,j]),x.useEffect(()=>{const n=Object.keys(a||{}).reduce((f,m)=>f+Object.keys(a[m]||{}).length,0);N(n>0)},[a]);const k=async()=>{o(!0);const n=new FormData;n.append("excel_file",j);try{const m=await(await fetch(route("admin.users.import.preview"),{method:"POST",body:n,headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),Accept:"application/json"}})).json();if(console.log("API Response:",m),m.success){console.log("Preview Data:",m.data),C(m.data);const y={};m.data.errors&&Array.isArray(m.data.errors)&&m.data.errors.forEach(s=>{s.severity==="error"&&(y[s.row]||(y[s.row]={}),y[s.row][s.column]=s)}),_(y)}else console.error("API Error:",m.message),alert(m.message||"Error loading file preview")}catch(f){console.error("Preview error:",f),alert("Error loading file preview. Please try again.")}finally{o(!1)}},A=async(n,f,m)=>{console.log("Cell edit:",{rowId:n,field:f,value:m});const y=l.rows.map(s=>s.row_id===n?{...s,[f]:m}:s);C({...l,rows:y}),z.current&&clearTimeout(z.current),z.current=setTimeout(async()=>{const s=y.find(r=>r.row_id===n);try{const t=await(await fetch(route("admin.users.import.validate-row"),{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),Accept:"application/json"},body:JSON.stringify({row_id:n,data:s})})).json();if(console.log("Validation result:",t),t.success){const i={...a};if(t.errors&&t.errors.length>0){const c={};t.errors.forEach(g=>{g.severity==="error"&&(c[g.column]=g)}),Object.keys(c).length>0?i[n]=c:delete i[n]}else delete i[n];_(i),C(c=>{const g=c.rows.map(h=>{if(h.row_id===n){const v={...h};return t.member_id&&t.member_id!==h.member_id&&(v.member_id=t.member_id),v}return h});return{...c,rows:g}})}}catch(r){console.error("Cell validation error:",r)}},500)},q=async()=>{if(w){alert("Please fix all validation errors before importing.");return}const n=l.rows.length,f=25,m=[];for(let t=0;t<n;t+=f)m.push(l.rows.slice(t,t+f));S({isImporting:!0,current:0,total:n,percentage:0}),o(!0);let y=0,s=0;const r=[];try{for(let t=0;t<m.length;t++){const c=m[t].map((T,B)=>{const{row_id:H,...L}=T;return{...L,row_number:t*f+B+1}}),g=await fetch(route("admin.users.import.batch"),{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),Accept:"application/json"},body:JSON.stringify({rows:c,chunk_size:f,session_id:l.session_id})});if(!g.ok){const T=await g.text();throw console.error("Import chunk error:",T),new Error(`HTTP ${g.status}: ${T}`)}const h=await g.json();if(h.success)y+=h.imported||0,s+=h.failed||0,h.failed_rows&&r.push(...h.failed_rows);else throw new Error(h.message||"Chunk import failed");const v=Math.min((t+1)*f,n),d=Math.round(v/n*100);S({isImporting:!0,current:v,total:n,percentage:d})}S({isImporting:!1,current:n,total:n,percentage:100}),E({success:!0,imported:y,failed:s,failed_rows:r,message:`Successfully imported ${y} user(s).`}),D()}catch(t){console.error("Import error:",t),alert("Import failed: "+t.message),S({isImporting:!1,current:0,total:0,percentage:0})}finally{o(!1)}},O=()=>{l!=null&&l.session_id&&fetch(route("admin.users.import.clear-session"),{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")}}),D()};return b?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{ref:F,className:"bg-white rounded-lg shadow-2xl w-full max-w-7xl h-full max-h-[90vh] flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200 bg-gray-50 rounded-t-lg",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("svg",{className:"w-6 h-6 text-green-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),e.jsxs("h2",{className:"text-xl font-semibold text-gray-900",children:["Excel Import - ",j==null?void 0:j.name]})]}),l&&l.rows&&e.jsxs("div",{className:"text-sm text-gray-600 bg-white px-3 py-1 rounded-full border",children:[((P=l.rows)==null?void 0:P.length)||0," rows • ",((V=l.columns)==null?void 0:V.length)||0," columns"]})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[l&&e.jsx("div",{className:`flex items-center space-x-2 px-3 py-1 rounded-full text-sm font-medium ${w?"bg-red-100 text-red-800 border border-red-200":"bg-green-100 text-green-800 border border-green-200"}`,children:w?e.jsxs(e.Fragment,{children:[e.jsx("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z",clipRule:"evenodd"})}),e.jsx("span",{children:"Has Errors"})]}):e.jsxs(e.Fragment,{children:[e.jsx("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z",clipRule:"evenodd"})}),e.jsx("span",{children:"Ready to Import"})]})}),e.jsx("button",{onClick:q,disabled:w||p||!l||u.isImporting,className:`px-6 py-2 rounded-lg font-medium transition-all ${w||p||!l||u.isImporting?"bg-gray-300 text-gray-500 cursor-not-allowed":"bg-green-600 text-white hover:bg-green-700 shadow-lg hover:shadow-xl"}`,children:u.isImporting?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("svg",{className:"animate-spin w-4 h-4",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),e.jsxs("span",{children:["Importing ",u.percentage,"%"]})]}):p?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("svg",{className:"animate-spin w-4 h-4",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),e.jsx("span",{children:"Processing..."})]}):"Import to Database"}),e.jsx("button",{onClick:O,disabled:u.isImporting,className:`p-2 rounded-lg transition-colors ${u.isImporting?"text-gray-300 cursor-not-allowed":"text-gray-400 hover:text-gray-600 hover:bg-gray-100"}`,children:e.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M6 18L18 6M6 6l12 12"})})})]})]}),e.jsxs("div",{className:"flex-1 overflow-hidden relative",children:[u.isImporting&&e.jsx("div",{className:"absolute inset-0 bg-white bg-opacity-95 z-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center w-full max-w-md px-8",children:[e.jsx("div",{className:"mb-6",children:e.jsxs("svg",{className:"animate-spin w-16 h-16 text-green-600 mx-auto",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Importing Users..."}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Please wait while we import your data"}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-4 mb-3 overflow-hidden",children:e.jsx("div",{className:"bg-gradient-to-r from-green-500 to-green-600 h-4 rounded-full transition-all duration-300 ease-out",style:{width:`${u.percentage}%`}})}),e.jsxs("div",{className:"flex justify-between text-sm text-gray-600",children:[e.jsxs("span",{children:[u.current," of ",u.total," rows"]}),e.jsxs("span",{className:"font-semibold text-green-600",children:[u.percentage,"%"]})]}),e.jsxs("p",{className:"text-sm text-gray-500 mt-4",children:["Processing",e.jsx("span",{className:"animate-pulse",children:"..."})]})]})}),p&&!l?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsxs("svg",{className:"animate-spin w-12 h-12 text-blue-600 mx-auto mb-4",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),e.jsx("p",{className:"text-lg font-medium text-gray-700",children:"Loading Excel file..."}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Parsing and validating data"})]})}):l?e.jsx(I,{data:l.rows,columns:l.columns||[],errors:a,onCellEdit:A,validationMetadata:R}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center text-gray-500",children:[e.jsx("svg",{className:"w-16 h-16 mx-auto mb-4 text-gray-300",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),e.jsx("p",{className:"text-lg",children:"No file loaded"})]})})]}),l&&e.jsx("div",{className:"p-4 border-t border-gray-200 bg-gray-50 rounded-b-lg",children:e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center space-x-6",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-3 h-3 bg-red-100 border-2 border-red-500 rounded"}),e.jsx("span",{className:"text-gray-600",children:"Validation Error"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-3 h-3 bg-green-100 border-2 border-green-500 rounded"}),e.jsx("span",{className:"text-gray-600",children:"Valid Data"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:"text-red-500 font-bold",children:"*"}),e.jsx("span",{className:"text-gray-600",children:"Required Field"})]})]}),e.jsx("div",{className:"text-gray-600",children:"Double-click cells to edit • Tab/Enter to navigate"})]})})]})}):null}function G({validationMetadata:b,onImportComplete:D}){const[j,R]=x.useState(!1),[E,l]=x.useState(null),C=p=>{const o=p.target.files[0];if(o){const w=o.name.toLowerCase();if(![".xlsx",".xls"].some(F=>w.endsWith(F))&&!["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-excel","application/excel","application/x-excel","application/x-msexcel",""].includes(o.type)){alert(`Please select a valid Excel file (.xlsx or .xls). Selected file: ${w}`);return}if(o.size>10*1024*1024){alert("File size must be less than 10MB");return}console.log("File selected:",{name:o.name,type:o.type,size:o.size}),l(o),R(!0)}},a=()=>{R(!1),l(null);const p=document.getElementById("excel-upload");p&&(p.value="")},_=p=>{R(!1),l(null);const o=document.getElementById("excel-upload");o&&(o.value=""),D&&D(p)};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"file",accept:".xlsx,.xls",onChange:C,className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10",id:"excel-upload"}),e.jsx(M,{variant:"outline",asChild:!0,className:"cursor-pointer",children:e.jsxs("label",{htmlFor:"excel-upload",children:[e.jsx($,{className:"h-4 w-4"}),"Import User Excel File"]})})]}),e.jsx(W,{isOpen:j,onClose:a,file:E,validationMetadata:b,onImport:_})]})}export{G as E};
